<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheel of Names – Global AI Community</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics-compat.js"></script>
  <style>
    :root {
      --bg-primary:   #091F2C;
      --bg-secondary: #0d1929;
      --bg-card:      #1e224e;
      --accent:       #d5522b;
      --accent-light: #e8762a;
      --accent-purple:       #d5522b;
      --accent-purple-light: #e8762a;
      --accent-orange: #d5522b;
      --text-primary:   #ffffff;
      --text-secondary: #bed7e4;
      --text-muted:     #8899a6;
      --border:      rgba(213,82,43,.22);
      --border-glow: rgba(213,82,43,.55);
      --grad-brand:  linear-gradient(135deg,#d5522b,#e8762a);
      --grad-wide:   linear-gradient(135deg,#1e224e,#d5522b,#e8762a);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Open Sans','Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;}
    h1,h2,h3,.logo-name,.header-title,.btn,.panel-title,.spinBtn,.pres-spin-btn,.winner-name,.join-card h1{font-family:'Montserrat',sans-serif;}
    /* HEADER */
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 32px;background:rgba(9,31,44,.96);border-bottom:1px solid rgba(255,255,255,.08);backdrop-filter:blur(16px);position:sticky;top:0;z-index:50;}
    .logo{display:flex;align-items:center;gap:14px;}
    .logo img{height:38px;display:block;}
    .logo-divider{width:1px;height:28px;background:rgba(255,255,255,.15);}
    .logo-sub{font-size:.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;font-family:'Montserrat',sans-serif;font-weight:700;}
    .header-title{font-size:1rem;font-weight:800;font-family:'Montserrat',sans-serif;letter-spacing:.03em;color:var(--accent-light);}
    .header-actions{display:flex;gap:8px;}
    .btn{padding:8px 16px;border:none;border-radius:6px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:'Montserrat',sans-serif;transition:all .2s;}
    .btn-primary{background:var(--grad-brand);color:#fff;box-shadow:0 2px 14px rgba(213,82,43,.35);}
    .btn-primary:hover{box-shadow:0 4px 24px rgba(213,82,43,.6);transform:translateY(-1px);}
    .btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid rgba(255,255,255,.15);}
    .btn-ghost:hover{color:var(--text-primary);background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.3);}
    /* LAYOUT */
    .main{display:grid;grid-template-columns:1fr 400px;min-height:calc(100vh - 65px);}
    /* WHEEL */
    .wheel-section{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 32px;position:relative;}
    .wheel-section::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse 60% 60% at 50% 50%,rgba(213,82,43,.05) 0%,transparent 70%);}
    .event-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 16px;margin-bottom:28px;background:rgba(213,82,43,.12);border:1px solid rgba(213,82,43,.35);border-radius:20px;font-size:.68rem;font-weight:700;color:var(--accent-light);text-transform:uppercase;letter-spacing:.1em;font-family:'Montserrat',sans-serif;}
    .wheel-container{position:relative;width:600px;height:600px;margin-bottom:32px;}
    #wheelCanvas{width:600px;height:600px;border-radius:50%;filter:drop-shadow(0 0 50px rgba(213,82,43,.35));}
    .pointer{position:absolute;top:-20px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-top:40px solid var(--accent);filter:drop-shadow(0 3px 8px rgba(0,0,0,.5));z-index:2;}
    .center-circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;background:radial-gradient(circle,#1e224e 0%,#091F2C 100%);border:3px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:22px;z-index:2;}
    #spinBtn{padding:18px 64px;font-size:1.1rem;font-weight:800;border:none;border-radius:50px;background:var(--grad-brand);color:#fff;cursor:pointer;font-family:'Montserrat',sans-serif;letter-spacing:.08em;text-transform:uppercase;box-shadow:0 4px 28px rgba(213,82,43,.45);transition:all .2s;}
    #spinBtn:hover{transform:scale(1.06);box-shadow:0 6px 40px rgba(213,82,43,.65);}
    #spinBtn:active{transform:scale(.97);}
    #spinBtn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none;}
    .spin-footer{display:flex;flex-direction:column;align-items:center;gap:14px;}
    .stats{font-size:.78rem;color:var(--text-muted);font-family:'Montserrat',sans-serif;}
    .stat-value{color:var(--accent-light);font-weight:700;}
    .wheel-qr-block{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:8px;}
    .wheel-qr-img{padding:10px;background:#fff;border-radius:12px;box-shadow:0 0 28px rgba(213,82,43,.35);}
    .wheel-qr-label{font-size:.65rem;color:var(--text-muted);text-align:center;max-width:280px;word-break:break-all;}
    /* SIDEBAR */
    .sidebar{background:var(--bg-secondary);border-left:1px solid rgba(255,255,255,.06);padding:24px;display:flex;flex-direction:column;gap:20px;overflow-y:auto;}
    .panel{background:rgba(30,34,78,.6);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:18px;}
    .panel-title{font-size:.65rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.12em;margin-bottom:14px;display:flex;align-items:center;gap:7px;font-family:'Montserrat',sans-serif;}
    .panel-title .icon{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;background:rgba(213,82,43,.2);border-radius:4px;font-size:11px;}
    #namesInput{width:100%;height:200px;padding:12px 14px;border:1px solid rgba(255,255,255,.1);border-radius:8px;background:rgba(9,31,44,.8);color:var(--text-primary);font-size:.88rem;line-height:1.75;resize:vertical;font-family:'Open Sans',sans-serif;transition:border-color .2s;}
    #namesInput:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(213,82,43,.15);}
    .sidebar-actions{display:flex;gap:8px;margin-top:10px;}
    .sidebar-actions .btn{flex:1;padding:9px 6px;font-size:.75rem;}
    #updateBtn{background:var(--grad-brand);color:#fff;}
    #updateBtn:hover{opacity:.88;}
    #shuffleBtn{background:rgba(255,255,255,.05);color:var(--text-secondary);border:1px solid rgba(255,255,255,.1);}
    #shuffleBtn:hover{background:rgba(255,255,255,.1);color:var(--text-primary);}
    #clearBtn{background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.25);}
    #clearBtn:hover{background:rgba(239,68,68,.2);}
    #pendingList{list-style:none;display:flex;flex-direction:column;gap:6px;max-height:120px;overflow-y:auto;}
    #pendingList li{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:rgba(213,82,43,.07);border:1px solid rgba(213,82,43,.2);border-radius:6px;font-size:.82rem;}
    #pendingList li .add-btn{background:var(--accent);color:#fff;border:none;border-radius:4px;padding:3px 9px;font-size:.7rem;cursor:pointer;font-family:'Montserrat',sans-serif;font-weight:700;}
    #pendingList li .add-btn:hover{background:var(--accent-light);}
    .empty-pending{font-size:.78rem;color:var(--text-muted);text-align:center;padding:6px 0;}
    .attendee-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;min-height:20px;}
    .attendee-chip{padding:4px 12px;border-radius:20px;font-size:.74rem;font-weight:600;color:#fff;white-space:nowrap;letter-spacing:.01em;}
    .attendee-count{font-size:.7rem;color:var(--text-muted);margin-bottom:10px;font-family:'Montserrat',sans-serif;}
    .edit-details summary{font-size:.72rem;color:var(--text-secondary);cursor:pointer;padding:5px 0 8px;user-select:none;list-style:none;display:flex;align-items:center;gap:5px;font-family:'Montserrat',sans-serif;}
    .edit-details summary::marker,.edit-details summary::-webkit-details-marker{display:none;}
    .edit-details summary::before{content:'✎ Edit names';}
    .edit-details[open] summary::before{content:'▴ Hide editor';}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;}
    .qr-img-wrap{padding:12px;background:#fff;border-radius:14px;box-shadow:0 0 30px rgba(213,82,43,.3);}
    .qr-url{font-size:.65rem;color:var(--text-muted);word-break:break-all;text-align:center;max-width:260px;}
    .qr-cta{font-size:.82rem;color:var(--accent-light);font-weight:700;text-align:center;letter-spacing:.02em;font-family:'Montserrat',sans-serif;}
    .panel-qr{border-color:rgba(213,82,43,.4)!important;background:linear-gradient(160deg,rgba(30,34,78,.8),rgba(9,31,44,.9))!important;box-shadow:0 0 28px rgba(213,82,43,.12);}
    /* PRESENTATION */
    .pres-mode{display:none;position:fixed;inset:0;background:var(--bg-primary);z-index:200;flex-direction:column;align-items:center;justify-content:center;}
    .pres-mode.active{display:flex;}
    .pres-header{position:absolute;top:0;left:0;right:0;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;}
    .pres-logo{display:flex;align-items:center;gap:12px;}
    .pres-logo img{height:34px;}
    .pres-logo-text{font-size:.78rem;font-weight:700;color:var(--text-secondary);font-family:'Montserrat',sans-serif;}
    .pres-close{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--text-secondary);padding:7px 14px;border-radius:6px;cursor:pointer;font-family:'Montserrat',sans-serif;font-size:.78rem;font-weight:600;}
    .pres-close:hover{color:var(--text-primary);background:rgba(255,255,255,.05);}
    .pres-wheel{position:relative;width:640px;height:640px;margin-bottom:36px;}
    #presCanvas{width:640px;height:640px;border-radius:50%;filter:drop-shadow(0 0 70px rgba(213,82,43,.4));}
    .pres-spin-btn{padding:22px 96px;font-size:1.4rem;font-weight:900;border:none;border-radius:50px;background:var(--grad-brand);color:#fff;cursor:pointer;font-family:'Montserrat',sans-serif;letter-spacing:.08em;text-transform:uppercase;box-shadow:0 4px 50px rgba(213,82,43,.5);transition:all .2s;}
    .pres-spin-btn:hover{transform:scale(1.05);box-shadow:0 6px 70px rgba(213,82,43,.7);}
    .pres-spin-btn:active{transform:scale(.97);}
    .pres-spin-btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none;}
    .pres-qr{position:absolute;bottom:28px;right:28px;background:rgba(30,34,78,.85);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;text-align:center;}
    .pres-qr p{font-size:.6rem;color:var(--accent-light);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-top:8px;font-family:'Montserrat',sans-serif;}
    .pres-count{position:absolute;bottom:36px;left:36px;font-size:1rem;color:var(--text-secondary);font-weight:600;font-family:'Montserrat',sans-serif;}
    .pres-count span{color:var(--accent-light);font-weight:900;font-size:1.3rem;}
    .pres-actions{display:flex;gap:10px;margin-top:18px;}
    .pres-clear-btn{padding:12px 36px;font-size:.95rem;font-weight:700;border:none;border-radius:50px;background:rgba(239,68,68,.15);color:#f87171;cursor:pointer;font-family:'Montserrat',sans-serif;border:1px solid rgba(239,68,68,.35);transition:all .2s;}
    .pres-clear-btn:hover{background:rgba(239,68,68,.35);color:#fff;}
    /* WINNER */
    .winner-overlay{display:none;position:fixed;inset:0;background:rgba(9,31,44,.92);backdrop-filter:blur(10px);z-index:350;justify-content:center;align-items:center;}
    .winner-overlay.show{display:flex;}
    .winner-card{background:#1e224e;border:2px solid rgba(213,82,43,.45);border-radius:24px;padding:60px 80px;text-align:center;animation:popIn .45s cubic-bezier(.34,1.56,.64,1);box-shadow:0 0 100px rgba(213,82,43,.3);}
    .winner-label{font-size:.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.18em;font-weight:700;margin-bottom:14px;font-family:'Montserrat',sans-serif;}
    .winner-emoji{font-size:4rem;display:block;margin-bottom:12px;}
    .winner-name{font-size:3.8rem;font-weight:900;line-height:1.05;background:var(--grad-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:36px;font-family:'Montserrat',sans-serif;}
    .winner-close{padding:13px 40px;border-radius:50px;background:rgba(213,82,43,.15);color:var(--accent-light);font-size:.95rem;font-weight:700;cursor:pointer;font-family:'Montserrat',sans-serif;border:1px solid rgba(213,82,43,.35);transition:all .2s;}
    .winner-close:hover{background:rgba(213,82,43,.35);color:#fff;}
    @keyframes popIn{0%{transform:scale(.55) translateY(30px);opacity:0}100%{transform:scale(1) translateY(0);opacity:1}}
    .confetti{position:fixed;z-index:360;animation:fall 3s ease-in forwards;border-radius:2px;}
    @keyframes fall{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(105vh) rotate(720deg)}}
    .toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(80px);background:#1e224e;border:1px solid rgba(213,82,43,.4);border-radius:10px;padding:13px 24px;font-size:.88rem;font-weight:700;color:var(--accent-light);box-shadow:0 8px 40px rgba(0,0,0,.5);z-index:500;transition:transform .4s cubic-bezier(.34,1.56,.64,1);font-family:'Montserrat',sans-serif;}
    .toast.show{transform:translateX(-50%) translateY(0);}
    /* JOIN PAGE */
    .join-page{display:none;min-height:100vh;background:var(--bg-primary);flex-direction:column;align-items:center;justify-content:center;padding:28px;}
    .join-page.active{display:flex;}
    .join-brand{display:flex;align-items:center;gap:16px;margin-bottom:36px;}
    .join-brand img{height:44px;}
    .join-card{background:#1e224e;border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:44px 40px;text-align:center;max-width:420px;width:100%;box-shadow:0 0 80px rgba(213,82,43,.15);}
    .join-big-icon{font-size:3.5rem;display:block;margin-bottom:14px;}
    .join-card h1{font-size:1.85rem;font-weight:900;margin-bottom:8px;background:var(--grad-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-family:'Montserrat',sans-serif;}
    .join-card .subtitle{color:var(--text-secondary);font-size:.88rem;margin-bottom:28px;}
    .join-input{width:100%;padding:16px 20px;margin-bottom:16px;border:2px solid rgba(255,255,255,.1);border-radius:10px;background:rgba(9,31,44,.8);color:var(--text-primary);font-size:1.1rem;text-align:center;font-family:'Open Sans',sans-serif;transition:border-color .2s;}
    .join-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(213,82,43,.15);}
    .join-submit{width:100%;padding:16px;border:none;border-radius:10px;background:var(--grad-brand);color:#fff;font-size:1rem;font-weight:800;cursor:pointer;font-family:'Montserrat',sans-serif;transition:all .2s;box-shadow:0 4px 24px rgba(213,82,43,.35);}
    .join-submit:hover{box-shadow:0 6px 40px rgba(213,82,43,.55);transform:translateY(-2px);}
    .join-success-wrap{display:none;}
    .join-success-wrap.show{display:block;}
    .join-ticket{background:rgba(213,82,43,.1);border:1px solid rgba(213,82,43,.3);border-radius:12px;padding:20px;margin:20px 0;}
    .join-ticket-name{font-size:2rem;font-weight:900;background:var(--grad-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-family:'Montserrat',sans-serif;}
    .join-ticket p{font-size:.75rem;color:var(--text-muted);margin-top:4px;}
    .join-qr-wrap{display:inline-block;padding:10px;background:#fff;border-radius:8px;margin:14px auto;}
    .join-hint{font-size:.8rem;color:var(--text-secondary);margin-top:10px;}
    .join-error{display:none;margin-bottom:12px;padding:10px 16px;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);border-radius:8px;color:#f87171;font-size:.85rem;font-weight:600;}
    .join-error.show{display:block;}
    .join-waiting{text-align:center;padding:8px 0;}
    .join-waiting .spinner{display:inline-block;width:36px;height:36px;border:3px solid rgba(213,82,43,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .join-waiting h2{font-size:1.4rem;font-weight:800;background:var(--grad-brand);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px;font-family:'Montserrat',sans-serif;}
    .join-waiting p{color:var(--text-secondary);font-size:.88rem;}
    .fb-status{font-size:.62rem;padding:3px 8px;border-radius:4px;font-weight:700;display:inline-block;margin-top:6px;font-family:'Montserrat',sans-serif;}
    .fb-status.ok{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);}
    .fb-status.err{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.25);}
    .logo img,.join-brand img,.pres-logo img{filter:brightness(0) invert(1);display:block;}
    @media(max-width:1060px){
      .main{grid-template-columns:1fr;}
      .sidebar{border-left:none;border-top:1px solid rgba(255,255,255,.06);}
      .wheel-container{width:360px;height:360px;}
      #wheelCanvas{width:360px;height:360px;}
    }
  </style>
</head>
<body>

<!-- MOBILE JOIN PAGE -->
<div class="join-page" id="joinPage">
  <div class="join-brand">
    <img src="https://globalai.community/images/logo.svg" alt="Global AI Community">
    <div class="logo-divider"></div>
    <span class="logo-sub">Meetup Wheel</span>
  </div>
  <div class="join-card" id="joinFormCard">
    <span class="join-big-icon">&#127921;</span>
    <h1>Join the Wheel!</h1>
    <p class="subtitle">Enter your name to be spun in the meetup wheel of names.</p>
    <input class="join-input" id="joinInput" type="text" placeholder="Your name&hellip;"
           autocomplete="off" autocapitalize="words" autocorrect="off">
    <button class="join-submit" id="joinSubmit">Add me to the wheel &#127919;</button>
  </div>
  <div class="join-success-wrap" id="joinSuccessWrap">
    <div class="join-card">
      <span class="join-big-icon">&#127881;</span>
      <h1>You&rsquo;re in!</h1>
      <div class="join-waiting">
        <div class="spinner"></div>
        <h2 id="joinTicketName"></h2>
        <p>You&rsquo;ve been added to the wheel!<br>Good luck when it spins!</p>
      </div>
      <p class="join-hint" style="margin-top:16px;">Good luck! &#127808;</p>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp">
  <header class="header">
    <div class="logo">
      <img src="https://globalai.community/images/logo.svg" alt="Global AI Community">
      <div class="logo-divider"></div>
      <span class="logo-sub">Meetup Edition</span>
    </div>
    <div class="header-title">&#127921; Wheel of Names</div>
    <div class="header-actions">
      <button class="btn btn-primary" id="presentBtn">&#x26F6; Present</button>
    </div>
  </header>

  <div class="main">
    <div class="wheel-section">
      <div class="event-badge">Global AI Community &middot; Meetup</div>
      <div class="wheel-container">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="1200" height="1200"></canvas>
        <div class="center-circle">&#127775;</div>
      </div>
      <div class="spin-footer">
        <button id="spinBtn">&#127919; SPIN THE WHEEL</button>
        <button id="mainClearBtn" class="pres-clear-btn" style="margin-top:8px;">&#10005; Clear All</button>
        <div class="stats">Participants: <span class="stat-value" id="countStat">0</span></div>

      </div>
    </div>

    <aside class="sidebar">
      <div class="panel">
        <div class="panel-title"><span class="icon">&#128101;</span> Attendees</div>
        <div class="attendee-chips" id="attendeeChips"></div>
        <p class="attendee-count" id="attendeeCount"></p>
        <details class="edit-details" id="editDetails">
          <summary></summary>
          <textarea id="namesInput" placeholder="Enter names, one per line&hellip;">Alice
Bob
Charlie
Diana
Ethan
Fiona
George
Hannah</textarea>
          <div class="sidebar-actions">
            <button class="btn" id="updateBtn">&#10003; Update</button>
            <button class="btn" id="shuffleBtn">&#128256; Shuffle</button>
            <button class="btn" id="clearBtn">&#10005; Clear</button>
          </div>
        </details>
      </div>
      <div class="panel">
        <div class="panel-title"><span class="icon">&#128242;</span> Joined via QR</div>
        <ul id="pendingList">
          <li class="empty-pending">No one yet &mdash; share the QR code!</li>
        </ul>
      </div>
      <div class="panel panel-qr">
        <div class="panel-title"><span class="icon">&#128241;</span> Join via Mobile</div>
        <div class="qr-wrap">
          <div class="qr-img-wrap"><img id="qrImg" alt="QR Code" style="display:block;"></div>
          <div class="qr-url" id="qrUrlLabel"></div>
          <div class="qr-cta">&#128247; Scan to add your name to the wheel</div>
          <span class="fb-status" id="fbStatus"></span>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- PRESENTATION MODE -->
<div class="pres-mode" id="presMode">
  <div class="pres-header">
    <div class="pres-logo">
      <img src="https://globalai.community/images/logo.svg" alt="Global AI Community">
      <span class="pres-logo-text">Global AI Community &middot; Meetup</span>
    </div>
    <button class="pres-close" id="presClose">&#10005; Exit (Esc)</button>
  </div>
  <div class="pres-wheel">
    <div class="pointer"></div>
    <canvas id="presCanvas" width="1280" height="1280"></canvas>
    <div class="center-circle" style="width:70px;height:70px;font-size:28px;">&#127775;</div>
  </div>
  <div class="pres-actions">
    <button class="pres-spin-btn" id="presSpinBtn">&#127919; SPIN THE WHEEL</button>
    <button class="pres-clear-btn" id="presClearBtn">&#10005; Clear All</button>
  </div>
  <div class="pres-count">Participants: <span id="presCount">0</span></div>
  <div class="pres-qr">
    <div class="qr-img-wrap" style="padding:8px;"><img id="presQrImg" alt="QR Code" style="display:block;"></div>
    <p>&#128241; Scan to join</p>
  </div>
</div>

<!-- WINNER OVERLAY -->
<div class="winner-overlay" id="winnerOverlay">
  <div class="winner-card">
    <div class="winner-label">&#127881; And the winner is&hellip;</div>
    <span class="winner-emoji">&#127942;</span>
    <div class="winner-name" id="winnerName"></div>
    <button class="winner-close" id="winnerClose">Continue &rarr;</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ─────────────────────────────────────────────────────────────────
// FIREBASE CONFIG  ← replace with your project values
// 1. https://console.firebase.google.com → New project → Add web app
// 2. Build → Realtime Database → Create database (start in test mode)
// 3. Paste your firebaseConfig object values below
// ─────────────────────────────────────────────────────────────────
window.FB_CFG = {
  apiKey:            'AIzaSyB4GH6gY13Wc5yzc9OZRfxF_l458ANfHvw',
  authDomain:        'wheel-global-ai.firebaseapp.com',
  databaseURL:       'https://wheel-global-ai-default-rtdb.europe-west1.firebasedatabase.app',
  projectId:         'wheel-global-ai',
  storageBucket:     'wheel-global-ai.firebasestorage.app',
  messagingSenderId: '201680074561',
  appId:             '1:201680074561:web:8dfb599db54795736913c0',
  measurementId:     'G-HTMEWPEDM2'
};
const FB_READY = true;
let fbDb = null;
try {
  // Guard against duplicate-init (hot reload, multiple tabs sharing SW, etc.)
  const _app = firebase.apps.length ? firebase.app() : firebase.initializeApp(window.FB_CFG);
  fbDb = _app.database();
  // Analytics only available in secure contexts
  if (location.protocol === 'https:' || location.hostname === 'localhost') {
    try { firebase.analytics(_app); } catch(_) {}
  }
} catch(e) { console.warn('Firebase init failed', e); }
(async () => {
  const params  = new URLSearchParams(window.location.search);
  const isJoin  = params.has('join');
  const addName = params.get('add');
  const baseUrl = location.origin + location.pathname;
  // Use the actual running URL so QR codes work on any host (local, staging, production)
  const joinUrl  = baseUrl + '?join';

  /* ── MOBILE JOIN MODE ── */
  if (isJoin) {
    document.getElementById('joinPage').classList.add('active');
    document.getElementById('mainApp').style.display = 'none';
    const inp = document.getElementById('joinInput');
    const btn = document.getElementById('joinSubmit');
    const fc  = document.getElementById('joinFormCard');
    const sw  = document.getElementById('joinSuccessWrap');
    const errEl = Object.assign(document.createElement('p'), {className:'join-error', id:'joinErrorMsg'});
    fc.insertBefore(errEl, btn);
    inp.focus();

    async function doJoin() {
      const name = inp.value.trim();
      if (!name) { inp.style.borderColor = '#ef4444'; return; }
      errEl.classList.remove('show');
      btn.disabled = true; btn.textContent = 'Adding…';

      if (!FB_READY || !fbDb) {
        // Fallback: show waiting card (manual flow)
        document.getElementById('joinTicketName').textContent = name;
        fc.style.display = 'none'; sw.classList.add('show');
        return;
      }

      try {
        // Timeout helper — abort if Firebase doesn't respond in 8 seconds
        function withTimeout(promise, ms) {
          return Promise.race([
            promise,
            new Promise((_, rej) => setTimeout(() => rej(new Error('Request timed out — check your network or Firebase config')), ms))
          ]);
        }
        const [namesSnap, pendingSnap] = await withTimeout(Promise.all([
          fbDb.ref('wheel/names').get(),
          fbDb.ref('wheel/pending').get()
        ]), 8000);
        const existing = (namesSnap.val() || '').split('\n').map(n => n.trim()).filter(Boolean);
        const inQueue  = Object.values(pendingSnap.val() || {}).map(v => v.name);
        const all = [...existing, ...inQueue];
        if (all.some(n => n.toLowerCase() === name.toLowerCase())) {
          errEl.textContent = '\u26a0\ufe0f \u201c' + name + '\u201d is already in the wheel or queue!';
          errEl.classList.add('show');
          btn.disabled = false; btn.textContent = 'Add me to the wheel \uD83C\uDFAF';
          return;
        }
        await withTimeout(fbDb.ref('wheel/pending').push({ name, ts: Date.now() }), 8000);
        document.getElementById('joinTicketName').textContent = name;
        fc.style.display = 'none'; sw.classList.add('show');
      } catch(e) {
        errEl.textContent = '\u26a0\ufe0f ' + (e.message || 'Unknown error — please try again');
        errEl.classList.add('show');
        btn.disabled = false; btn.textContent = 'Add me to the wheel \uD83C\uDFAF';
        console.error('Join failed:', e);
      }
    }
    btn.addEventListener('click', doJoin);
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') doJoin(); });
    return;
  }

  /* ── MAIN APP ── */
  const wCanvas = document.getElementById('wheelCanvas');
  const wCtx    = wCanvas.getContext('2d');
  const pCanvas = document.getElementById('presCanvas');
  const pCtx    = pCanvas.getContext('2d');
  const spinBtn     = document.getElementById('spinBtn');
  const presSpinBtn = document.getElementById('presSpinBtn');
  const namesInput  = document.getElementById('namesInput');
  const updateBtn   = document.getElementById('updateBtn');
  const shuffleBtn  = document.getElementById('shuffleBtn');
  const clearBtn    = document.getElementById('clearBtn');
  const presentBtn  = document.getElementById('presentBtn');
  const presClose   = document.getElementById('presClose');
  const presMode    = document.getElementById('presMode');
  const winnerOverlay = document.getElementById('winnerOverlay');
  const winnerNameEl  = document.getElementById('winnerName');
  const winnerClose   = document.getElementById('winnerClose');
  const countStat   = document.getElementById('countStat');
  const presCount   = document.getElementById('presCount');
  const pendingList = document.getElementById('pendingList');
  const toastEl     = document.getElementById('toast');

  const COLORS = [
    '#7c3aed','#ec4899','#06b6d4','#f59e0b',
    '#10b981','#f97316','#3b82f6','#8b5cf6',
    '#ef4444','#14b8a6','#d946ef','#eab308',
    '#6366f1','#22d3ee','#e11d48','#0ea5e9'
  ];
  let names = [], rotation = 0, spinning = false, inPres = false, pending = [];
  let joinedViaQR = [];  // persistent list of names joined via QR (never cleared by Firebase listeners)

  /* ── MULTI-INSTANCE SYNC via BroadcastChannel ── */
  const bc = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel('wheel-sync') : null;
  function broadcast() {
    bc?.postMessage({ namesText: namesInput.value, pending: [...pending] });
  }
  if (bc) {
    bc.onmessage = ({ data }) => {
      namesInput.value = data.namesText;
      pending = data.pending;
      parseNames(); draw(); renderPending();
    };
  }

  /* ── DUPLICATE CHECK (case-insensitive) ── */
  function nameExists(name) {
    const lc = name.toLowerCase();
    return names.some(n => n.toLowerCase() === lc) ||
           pending.some(p => (typeof p === 'string' ? p : p.name).toLowerCase() === lc);
  }

  const audio = new (window.AudioContext || window.webkitAudioContext)();
  function tick() {
    const o = audio.createOscillator(), g = audio.createGain();
    o.connect(g); g.connect(audio.destination);
    o.type = 'sine'; o.frequency.value = 2000;
    g.gain.setValueAtTime(0.055, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.05);
    o.start(); o.stop(audio.currentTime + 0.05);
  }

  function renderAttendees() {
    const chips   = document.getElementById('attendeeChips');
    const countEl = document.getElementById('attendeeCount');
    if (!chips) return;
    chips.innerHTML = '';
    const list = names.filter(n => n !== '(empty)');
    list.forEach((name, i) => {
      const chip = document.createElement('span');
      chip.className = 'attendee-chip';
      chip.style.background = COLORS[i % COLORS.length];
      chip.title = name;
      chip.textContent = name;
      chips.appendChild(chip);
    });
    if (countEl) countEl.textContent = list.length ? list.length + ' on the wheel' : 'No participants yet';
  }

  function parseNames() {
    names = namesInput.value.split('\n').map(n => n.trim()).filter(Boolean);
    if (!names.length) names = ['(empty)'];
    const n = names.length === 1 && names[0] === '(empty)' ? 0 : names.length;
    countStat.textContent = presCount.textContent = n;
    renderAttendees();
  }

  function drawOn(ctx, canvas) {
    const W = canvas.width, cx = W/2, cy = W/2, R = W/2 - 14;
    ctx.clearRect(0, 0, W, W);
    const slice = (2 * Math.PI) / names.length;
    names.forEach((name, i) => {
      const s = rotation + i * slice, e = s + slice;
      ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, R, s, e); ctx.closePath();
      ctx.fillStyle = COLORS[i % COLORS.length]; ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 3; ctx.stroke();
      ctx.save(); ctx.translate(cx, cy); ctx.rotate(s + slice/2);
      ctx.textAlign = 'right'; ctx.fillStyle = '#fff';
      ctx.shadowColor = 'rgba(0,0,0,.65)'; ctx.shadowBlur = 5;
      const fs = Math.max(W/70, Math.min(W/26, W * 1.4 / Math.max(names.length, 1) / 9));
      ctx.font = '700 ' + fs + 'px Inter,system-ui,sans-serif';
      let txt = name;
      while (ctx.measureText(txt).width > R * 0.52 && txt.length > 1) txt = txt.slice(0, -1);
      if (txt !== name) txt += '\u2026';
      ctx.fillText(txt, R - 28, fs / 3);
      ctx.shadowBlur = 0; ctx.restore();
    });
    ctx.beginPath(); ctx.arc(cx, cy, R, 0, 2 * Math.PI);
    ctx.strokeStyle = 'rgba(124,58,237,.5)'; ctx.lineWidth = 8; ctx.stroke();
  }

  function draw() { drawOn(wCtx, wCanvas); if (inPres) drawOn(pCtx, pCanvas); }

  function winIdx() {
    const sl = (2 * Math.PI) / names.length;
    let a = (-Math.PI / 2 - rotation) % (2 * Math.PI);
    if (a < 0) a += 2 * Math.PI;
    return Math.floor(a / sl) % names.length;
  }

  function spin() {
    if (spinning || names.length <= 1) return;
    spinning = true; spinBtn.disabled = presSpinBtn.disabled = true;
    if (audio.state === 'suspended') audio.resume();
    const total = (6 + Math.random() * 6) * 2 * Math.PI + Math.random() * 2 * Math.PI;
    const start = rotation, dur = 4500 + Math.random() * 2000, t0 = performance.now();
    let last = -1;
    function frame(now) {
      const t = Math.min((now - t0) / dur, 1), ease = 1 - Math.pow(1 - t, 4);
      rotation = start + total * ease;
      const sl = (2 * Math.PI) / names.length;
      const si = Math.floor(((rotation % (2 * Math.PI)) + 2 * Math.PI) / sl) % names.length;
      if (si !== last) { last = si; tick(); }
      draw();
      if (t < 1) { requestAnimationFrame(frame); }
      else { spinning = false; spinBtn.disabled = presSpinBtn.disabled = false; showWinner(names[winIdx()]); }
    }
    requestAnimationFrame(frame);
  }

  function showWinner(name) {
    winnerNameEl.textContent = name;
    winnerOverlay.classList.add('show');
    rainConfetti();
  }

  function rainConfetti() {
    const C = ['#d5522b','#e8762a','#1e224e','#bed7e4','#fff','#f59e0b','#0ea5e9','#10b981'];
    for (let i = 0; i < 110; i++) {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.cssText = 'left:' + Math.random()*100 + 'vw;top:-8px;background:' + C[i%C.length]
        + ';width:' + (6+Math.random()*10) + 'px;height:' + (6+Math.random()*10)
        + 'px;border-radius:' + (Math.random()>.5?'50%':'2px')
        + ';animation-delay:' + Math.random()*.9 + 's;animation-duration:' + (2.5+Math.random()*2) + 's;';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 5500);
    }
  }

  function toast(msg, ms = 3200) {
    toastEl.textContent = msg; toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), ms);
  }

  function renderPending() {
    pendingList.innerHTML = '';
    if (!joinedViaQR.length) {
      pendingList.innerHTML = '<li class="empty-pending">No one yet &mdash; share the QR code!</li>';
      return;
    }
    joinedViaQR.forEach((name) => {
      const li = document.createElement('li');
      li.innerHTML = '<span>\u2705 ' + name + '</span>';
      pendingList.appendChild(li);
    });
  }

  function makeQR(imgEl, url, size) {
    imgEl.src = 'https://api.qrserver.com/v1/create-qr-code/?size=' + size + 'x' + size
      + '&data=' + encodeURIComponent(url) + '&margin=10&format=png';
    imgEl.width  = size;
    imgEl.height = size;
    imgEl.alt    = url;
  }

  document.getElementById('qrUrlLabel').textContent = joinUrl;
  makeQR(document.getElementById('qrImg'),     joinUrl, 220);
  makeQR(document.getElementById('presQrImg'), joinUrl, 100);

  /* ── FIREBASE REALTIME LISTENERS ── */
  const fbStatusEl = document.getElementById('fbStatus');
  if (fbDb) {
    fbStatusEl.textContent = '\u26a1 Firebase connected';
    fbStatusEl.className = 'fb-status ok';

    // Sync names across presenter tabs/devices
    fbDb.ref('wheel/names').on('value', snap => {
      const val = snap.val();
      if (val !== null && val !== namesInput.value) {
        namesInput.value = val;
        parseNames(); draw();
        // Propagate the Firebase update to other same-browser tabs
        broadcast();
      }
    });

    // Live pending queue:
    // child_added fires for ALL existing entries when listener attaches,
    // then for truly-new entries afterward. We suppress toasts during
    // the initial load burst using a flag that clears after a short delay.
    let initialLoad = true;
    fbDb.ref('wheel/pending').once('value', () => { initialLoad = false; });

    // Debounce the wheel/names write so rapid child_added events don't race
    let namesSaveTimer = null;
    function scheduleNamesSave() {
      clearTimeout(namesSaveTimer);
      namesSaveTimer = setTimeout(() => {
        fbDb.ref('wheel/names').set(namesInput.value).catch(() => {});
      }, 300);
    }

    fbDb.ref('wheel/pending').on('child_added', snap => {
      if (!pending.find(p => p.key === snap.key)) {
        const item = { key: snap.key, name: snap.val().name };
        pending.push(item); renderPending();
        // Auto-add to wheel (no manual approval) — skip duplicates already on the wheel
        const alreadyOnWheel = names.some(n => n.toLowerCase() === item.name.toLowerCase());
        if (!alreadyOnWheel) {
          namesInput.value = (namesInput.value.trim() + '\n' + item.name).trim();
          parseNames(); draw();
          joinedViaQR.push(item.name);
          renderPending();
          if (!initialLoad) toast('\ud83d\udcf2 ' + item.name + ' joined via QR!', 4000);
          scheduleNamesSave();
          broadcast();
        }
        // Remove from pending queue (keep in local list for display)
        fbDb.ref('wheel/pending/' + snap.key).remove().catch(() => {});
      }
    });
    fbDb.ref('wheel/pending').on('child_removed', snap => {
      pending = pending.filter(p => p.key !== snap.key);
      renderPending(); broadcast();
    });
  } else {
    fbStatusEl.textContent = '\u26a0\ufe0f Firebase not connected';
    fbStatusEl.className = 'fb-status err';
  }

  // ?add=NAME fallback (used when Firebase is not configured)
  if (addName && !fbDb) {
    const d = decodeURIComponent(addName);
    if (nameExists(d)) {
      toast('\u26a0\ufe0f ' + d + ' is already on the wheel or in the queue.', 5000);
    } else {
      pending.push(d); renderPending(); broadcast();
      toast('\ud83d\udcf2 ' + d + ' joined via QR!', 5000);
    }
    history.replaceState({}, '', baseUrl);
  }

  presentBtn.addEventListener('click', () => {
    inPres = true; presMode.classList.add('active');
    document.body.style.overflow = 'hidden';
    presMode.requestFullscreen?.().catch(() => {});
    draw();
  });
  function exitPres() {
    inPres = false; presMode.classList.remove('active');
    document.body.style.overflow = '';
    document.exitFullscreen?.().catch(() => {});
  }
  presClose.addEventListener('click', exitPres);
  document.getElementById('presClearBtn').addEventListener('click', clearAll);
  document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && inPres) exitPres(); });
  spinBtn.addEventListener('click', spin);
  presSpinBtn.addEventListener('click', spin);
  updateBtn.addEventListener('click', () => {
    parseNames(); draw(); broadcast();
    if (fbDb) fbDb.ref('wheel/names').set(namesInput.value).catch(() => {});
    toast('\u2705 Wheel updated!');
  });
  shuffleBtn.addEventListener('click', () => {
    parseNames();
    for (let i = names.length-1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [names[i], names[j]] = [names[j], names[i]];
    }
    namesInput.value = names.join('\n'); draw(); broadcast();
    if (fbDb) fbDb.ref('wheel/names').set(namesInput.value).catch(() => {});
    toast('\ud83d\udd00 Names shuffled!');
  });
  function clearAll() {
    if (confirm('Clear all names from the wheel?')) {
      namesInput.value = ''; joinedViaQR = []; pending = [];
      parseNames(); draw(); renderPending(); broadcast();
      if (fbDb) {
        fbDb.ref('wheel/names').set('').catch(() => {});
        fbDb.ref('wheel/pending').remove().catch(() => {});
      }
      toast('\ud83d\uddd1\ufe0f Wheel cleared!');
    }
  }
  clearBtn.addEventListener('click', clearAll);
  document.getElementById('mainClearBtn').addEventListener('click', clearAll);
  winnerClose.addEventListener('click', () => winnerOverlay.classList.remove('show'));
  winnerOverlay.addEventListener('click', e => { if (e.target === winnerOverlay) winnerOverlay.classList.remove('show'); });
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.activeElement !== namesInput) spin();
    if (e.key === 'Escape') { winnerOverlay.classList.remove('show'); exitPres(); }
    if ((e.key === 'f' || e.key === 'F') && document.activeElement !== namesInput) presentBtn.click();
  });

  parseNames(); renderPending(); draw();
})();
</script>
</body>
</html>
